A20 地址线问题
1981 年 8 月,IBM 公司最初推出的个人计算机 IBM PC 使用的 CPU 是 Intel 8088。在该微机中地址线
只有 20 根(A0 – A19)。在当时内存 RAM 只有几百 KB 或不到 1MB 时,20 根地址线已足够用来寻址这些内
存。其所能寻址的最高地址是 0xffff:0xffff,也即 0x10ffef。对于超出 0x100000(1MB)的寻址地址将默
认地环绕到 0x0ffef。当 IBM 公司于 1985 年引入 AT 机时,使用的是 Intel 80286 CPU,具有 24 根地址线,
最高可寻址 16MB,并且有一个与 8088 完全兼容的实模式运行方式。然而,在寻址值超过 1MB 时它却不能
象 8088 那样实现地址寻址的环绕。但是当时已经有一些程序是利用这种地址环绕机制进行工作的。为了
实现完全的兼容性,IBM 公司发明了使用一个开关来开启或禁止 0x100000 地址比特位。由于在当时的 8042
键盘控制器上恰好有空闲的端口引脚(输出端口 P2,引脚 P21)
,于是便使用了该引脚来作为与门控制这
个地址比特位。该信号即被称为 A20。如果它为零,则比特 20 及以上地址都被清除。从而实现了兼容性。
由于在机器启动时,默认条件下,A20 地址线是禁止的,所以操作系统必须使用适当的方法来开启它。
但是由于各种兼容机所使用的芯片集不同,要做到这一点却是非常的麻烦。因此通常要在几种控制方法中
选择。
对 A20 信号线进行控制的常用方法是通过设置键盘控制器的端口值。这里的 setup.s 程序(138-144
行)即使用了这种典型的控制方式。对于其它一些兼容微机还可以使用其它方式来做到对 A20 线的控制。
有些操作系统将 A20 的开启和禁止作为实模式与保护运行模式之间进行转换的标准过程中的一部分。
由于键盘的控制器速度很慢,因此就不能使用键盘控制器对 A20 线来进行操作。为此引进了一个 A20 快速
门选项(Fast Gate A20),它使用 I/O 端口 0x92 来处理 A20 信号线,避免了使用慢速的键盘控制器操作方
式。对于不含键盘控制器的系统就只能使用 0x92 端口来控制,但是该端口也有可能被其它兼容微机上的
设备(如显示芯片)所使用,从而造成系统错误的操作。
还有一种方式是通过读 0xee 端口来开启 A20 信号线,写该端口则会禁止 A20 信号线。

Intel CPU 32 位保护运行模式
Intel CPU 一般可以在两种模式下运行,即实地址模式和保护模式。早期的 Intel CPU(8088/8086)
只能工作在实模式下,某一时刻只能运行单个任务。对于 Intel 80386 以上的芯片则还可以运行在 32 位
保护模式下。在保护模式下运行可以支持多任务;支持 4G 的物理内存;支持虚拟内存;支持内存的页式
管理和段式管理;支持特权级。

中断向量表中,int 0x41 的中断向量位置(4 * 0x41 =0x0000:0x0104)存放的并不是中断程序的地
址,而是第一个硬盘的基本参数表。对于 100%兼容的 BIOS 来说,这里存放着硬盘参数表阵列的首地址
F000h:E401h。第二个硬盘的基本参数表入口地址存于 int 0x46 中断向量位置处。
